<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>ë¡œì»¬ë§ˆì¼“</title>
<meta name="description" content="ì¤‘ê³ ê±°ë˜ SPA í¬íŠ¸í´ë¦¬ì˜¤. ì „ì—­ ê²€ìƒ‰/í•„í„°/ì •ë ¬, ì¹´í…Œê³ ë¦¬ íŒ¨ë„, ìƒì„¸/íŒë§¤ì í˜ì´ì§€, ì‹¤ì‚¬ìš© íë¦„ìš© ì±„íŒ…Â·ê±°ë˜ë°©, ë¬´í•œìŠ¤í¬ë¡¤, ì°œ/ìµœê·¼ë³¸ ì €ì¥.">
<style>
  :root{
    --ink:#0f172a;--sub:#64748b;--bg:#f3f5f8;--line:#e5e8eb;
    --panel:#fff;--container:1180px;--accent:#22c55e;
    --brand:linear-gradient(135deg,#22c55e 0%,#f97316 100%);
    --shadow:0 14px 36px rgba(2,6,23,.10);
    --radius:16px;
  }
  *{box-sizing:border-box}
  html,body{margin:0;background:var(--bg);color:var(--ink);font-family:-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial,Noto Sans KR,Apple SD Gothic Neo,sans-serif}
  a{color:inherit;text-decoration:none}
  img{display:block;max-width:100%}
  .container{max-width:var(--container);margin:0 auto;padding:0 18px}
  .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;padding:10px 14px;border:1px solid var(--line);border-radius:12px;background:#fff;font-weight:800;cursor:pointer}
  .btn.primary{background:var(--brand);border-color:transparent;color:#fff}
  .btn.ghost{background:#fff;border:1px solid var(--line)}
  .btn.icon{padding:8px 10px;border-radius:999px}
  .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#fff;font-size:12px}
  .chip.active{background:#f8fffa;border-color:#c7f0d6}
  .shadow{box-shadow:var(--shadow)}
  .grid{display:grid;gap:16px}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);padding:14px}
  .section-title{display:flex;justify-content:space-between;align-items:end;border-bottom:1px solid var(--line);padding-bottom:12px;margin-bottom:14px}
  .section-title h2{margin:0;font-size:22px}

  /* Topbar */
  .topbar{position:sticky;top:0;z-index:30;background:rgba(255,255,255,.92);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .topbar .inner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:10px 0}
  .brand{display:flex;align-items:center;gap:10px;font-weight:900}
  .badge{width:34px;height:34px;border-radius:10px;background:var(--brand);display:grid;place-items:center;color:#fff}
  .search{flex:1;max-width:740px;display:flex;align-items:center;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:#fff;gap:8px}
  .search input{flex:1;border:0;background:transparent;outline:none;font-size:15px;padding:6px}
  .search input::placeholder{color:#9aa7b3}

  /* Landing */
  .landing{min-height:88svh;display:grid;place-items:center;background:
    radial-gradient(1200px 260px at 15% 0%, #e9fff2 0%, rgba(233,255,242,0) 60%),
    radial-gradient(1200px 260px at 85% 0%, #fff0e5 0%, rgba(255,240,229,0) 60%),
    linear-gradient(#fff,#f5f7fb);border-bottom:1px solid var(--line)}
  .hero{display:grid;grid-template-columns:1.2fr 1fr;gap:26px;align-items:center}
  .headline{margin:0;font-size:52px;line-height:1.08}
  .subtitle{margin:12px 0 20px;color:#334155}
  .phone{aspect-ratio:9/16;border:1px solid #e2e8f0;border-radius:26px;background:#fff;overflow:hidden;transform:rotate(-6deg);box-shadow:0 24px 60px rgba(2,6,23,.15)}
  .phone-in{width:92%;height:92%;margin:4%;border:1px solid #e5e7eb;border-radius:22px;overflow:hidden;display:grid;grid-template-rows:auto 1fr;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,.5),rgba(255,255,255,.25))}
  .phone-top{padding:10px 14px;display:flex;justify-content:space-between;font-weight:900}
  .slot{border-radius:18px;overflow:hidden}

  /* Main shell */
  main{margin-top:26px}
  .shell{display:grid;grid-template-columns:280px 1fr;gap:18px}

  /* Facets */
  .facet{display:grid;gap:8px}
  .facet label{display:flex;align-items:center;gap:10px;padding:8px;border-radius:10px;cursor:pointer}
  .facet label:hover{background:#f8fafc}
  .facet input{appearance:none;width:20px;height:20px;border-radius:50%;border:2px solid #cbd5e1;display:grid;place-items:center}
  .facet input:checked{border-color:var(--accent);box-shadow:inset 0 0 0 6px var(--accent)}
  .count{margin-left:auto;color:#94a3b8}

/* ê°€ê²© ì»¨íŠ¸ë¡¤: ì…ë ¥/ë²„íŠ¼ ê·œê²© í†µì¼ */
.controls .row input,
.controls .row .btn {
  height: 44px;
  font-size: 14px;
  border: 1px solid #e2e8f0;
  border-radius: 10px;
  padding: 0 12px;
  box-sizing: border-box;
}

/* ì…ë ¥ì°½ì€ ì…€ ê½‰ ì±„ìš°ê¸° */
.controls .row input {
  width: 100%;
  min-width: 0;
}

/* ë²„íŠ¼ë„ ì…€ ê½‰ ì±„ìš°ê¸° */
.controls .row .btn {
  width: 100%;
  background: #fff;
  font-weight: 800;
}

/* (ì˜µì…˜) ìˆ«ì ì…ë ¥ ìŠ¤í”¼ë„ˆ ì œê±°ë¡œ ë†’ì´ ê· ì¼í™” */
input[type=number]::-webkit-outer-spin-button,
input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
input[type=number] { -moz-appearance: textfield; }


  /* Goods grid */
  .grid.goods{grid-template-columns:repeat(4,1fr)}
  .card{background:#fff;border:1px solid var(--line);border-radius:16px;overflow:hidden;cursor:pointer;transition:transform .12s}
  .card:hover{transform:translateY(-3px)}
  .thumb{position:relative;aspect-ratio:4/3;background:#eef2f7}
  .thumb img{width:100%;height:100%;object-fit:cover}
  .thumb.noimg{background:#e7ebf0}
  .thumb.noimg::after{content:"ì „ì‹œ ì¤€ë¹„ì¤‘";position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.45);color:#fff;font-weight:900;border-radius:10px;padding:6px 10px}
  .badge-corner{position:absolute;left:8px;top:8px;background:#fff;border:1px solid var(--line);border-radius:8px;padding:4px 8px;font-size:12px}
  .like{position:absolute;top:8px;right:8px;background:#fff;border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px}
  .meta{padding:12px}.price{font-weight:900;font-size:18px}.title{margin:6px 0 2px;font-weight:800}.desc{font-size:13px;color:var(--sub)}
  #empty{display:none;padding:24px;text-align:center;border:1px dashed var(--line);border-radius:12px;background:#fff;color:#64748b}
  #moreWrap{display:none;justify-content:center;margin-top:12px}

  /* Detail */
  #page-detail{display:none}
  #page-detail.active{display:block}
  .crumb{display:flex;gap:6px;font-size:13px;color:#6b7280;padding:8px 0 16px}
  .detail{display:grid;grid-template-columns:1.05fr .95fr;gap:18px}
  .gallery{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px}
  .heroimg{aspect-ratio:4/3;border-radius:12px;background:#eef2f7;overflow:hidden}
  .heroimg img{width:100%;height:100%;object-fit:cover}
  .heroimg.noimg{display:grid;place-items:center;position:relative}
  .heroimg.noimg::after{content:"ì „ì‹œ ì¤€ë¹„ì¤‘";position:absolute;background:rgba(0,0,0,.45);color:#fff;font-weight:900;border-radius:10px;padding:8px 12px}
  .thumbs{display:grid;grid-template-columns:repeat(6,1fr);gap:8px;margin-top:10px}
  .thumbs button{border:1px solid var(--line);border-radius:10px;padding:0;background:#fff;overflow:hidden;cursor:pointer}
  .side{display:grid;gap:12px}
  .detail-card{background:#fff;border:1px solid var(--line);border-radius:16px;padding:16px;position:relative}
  .title.big{margin:0 0 8px;font-size:26px}
  .price.big{font-size:28px;font-weight:900}
  .detail-card h1,.detail-card .meta,.detail-card .priceRow,.detail-card .badges,.detail-card .seller{text-align:left}
  .like-top{position:absolute;top:16px;right:16px;padding:8px 12px;border-radius:12px;line-height:1}
  .priceRow{display:flex;align-items:center;gap:10px;margin-top:10px;flex-wrap:wrap}
  .badges{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .seller{margin-top:12px}
  .seller-link{display:flex;gap:12px;align-items:center}
  .avatar{width:48px;height:48px;border-radius:50%;border:1px solid var(--line);background:#e2e8f0;flex:0 0 auto;aspect-ratio:1/1}
  .avatar.lg{width:72px;height:72px;aspect-ratio:1/1;border-radius:50%}
  #sellerMeta{color:#64748b}

  .tabs{margin-top:12px}
  .tablist{display:flex;gap:6px;border-bottom:1px solid var(--line)}
  .tab{appearance:none;background:#fff;border:1px solid var(--line);border-bottom:none;border-radius:10px 10px 0 0;padding:10px 12px;font-weight:800;cursor:pointer}
  .tab[aria-selected="true"]{background:#f8fffa;border-color:#c7f0d6}
  .tabpanel{display:none;border:1px solid var(--line);border-top:none;border-radius:0 12px 12px 12px;padding:14px;background:#fff}
  .tabpanel.active{display:block}
  .reviews .item{border-bottom:1px dashed #eaecef;padding:10px 0}
  .stars{color:#f59e0b}
  .qa .q{font-weight:800}
  .qa .a{color:#334155}

  .bottombar{display:none;position:sticky;bottom:0;background:rgba(255,255,255,.93);backdrop-filter:blur(6px);border-top:1px solid var(--line);padding:10px}
  .bottombar .container{display:flex;gap:8px}
  .bottombar .btn{flex:1}

  /* Seller page */
  #page-seller{display:none}
  #page-seller.active{display:block}
  .seller-head{display:flex;gap:14px;align-items:center}
  .seller-title{margin:0}
  .seller-stats{color:#64748b;margin-top:4px}
  .seller-chips{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}

  /* Deal / Chat */
  #page-deal{display:none}
  #page-deal.active{display:block}
  .deal-top{display:flex;gap:12px;align-items:center}
  .deal-thumb{width:64px;height:64px;border-radius:12px;overflow:hidden;border:1px solid var(--line);flex:0 0 auto}
  .deal-thumb img{width:100%;height:100%;object-fit:cover}
  .deal-meta{color:#64748b}
  .deal-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
  .chat{background:#fff;border:1px solid var(--line);border-radius:16px;padding:12px;height:420px;display:flex;flex-direction:column}
  .msgs{flex:1;overflow:auto;display:grid;gap:10px;padding-right:4px}
  .msg{max-width:70%;padding:8px 10px;border:1px solid var(--line);border-radius:14px;line-height:1.4;word-break:break-word}
  .msg.other{justify-self:start;background:#f8fafc}
  .msg.me{justify-self:end;background:#f1fff6;border-color:#c7f0d6}
  .composer{display:flex;gap:8px;margin-top:10px}
  .composer input, .composer textarea{flex:1;border:1px solid var(--line);border-radius:10px;padding:10px}
  .deal-form{display:grid;gap:8px;margin-top:10px}
  .deal-row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .deal-row .chip{cursor:pointer}

  footer{margin-top:36px;border-top:1px solid var(--line);background:#fff}
  .foot{padding:20px 0;color:#64748b}

  @media (max-width:1100px){.grid.goods{grid-template-columns:repeat(3,1fr)}.headline{font-size:46px}}
  @media (max-width:900px){.shell{grid-template-columns:1fr}.panel{position:sticky;top:64px}}
  @media (max-width:768px){
    .hero{grid-template-columns:1fr}.phone{transform:none;max-width:360px;margin:0 auto}
    .grid.goods{grid-template-columns:repeat(2,1fr)}.detail{grid-template-columns:1fr}.bottombar{display:block}
  }
  @media (max-width:420px){.grid.goods{grid-template-columns:1fr}}

/* ----- Detail card tidy ----- */
.detail-card.tidy { padding:18px; }
.detail-head{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; }
.detail-head .title{ margin:0; line-height:1.15; }
.location{ color:#64748b; margin-top:4px; }

.like-top{ position:static; border-radius:999px; padding:8px 12px; }
.like-top.icon{ font-weight:800; }

.price.big{ font-size:32px; }
.price-box{ display:flex; align-items:center; gap:12px; margin-top:10px; }

.chip.tone{ background:#f8fffa; border-color:#c7f0d6; font-weight:700; }

/* ë°°ì§€ë“¤ì„ 2~3ì—´ ê·¸ë¦¬ë“œë¡œ ê¹”ë”í•˜ê²Œ */
.pill-row{ display:grid; grid-template-columns:repeat(3, minmax(0,1fr)); gap:8px; margin-top:12px; }
.pill-row .chip{ width:100%; justify-content:center; padding:8px 10px; border-color:#e5e7eb; background:#f8fafc; }

/* ì–‡ì€ êµ¬ë¶„ì„  */
.sep{ border:0; border-top:1px solid var(--line); margin:14px 0; }

/* íŒë§¤ì ì¹´ë“œ */
.seller-card{ display:grid; grid-template-columns:auto 1fr auto; align-items:center; gap:12px;
  padding:12px; border:1px solid var(--line); border-radius:12px; background:#fff; text-decoration:none; }
.seller-card:hover{ box-shadow:var(--shadow); transform:translateY(-1px); transition:.12s; }
.seller-info strong{ display:block; margin-bottom:2px; }
.forward{ color:#94a3b8; font-size:22px; line-height:1; }

/* CTA ë²„íŠ¼ 2ì—´ â†’ ëª¨ë°”ì¼ 1ì—´ */
.cta-row{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:14px; }
.btn.block{ width:100%; }

@media (max-width:768px){
  .pill-row{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  .cta-row{ grid-template-columns:1fr; }
}

/* ì•„ë°”íƒ€ ì°Œê·¸ëŸ¬ì§ ë°©ì§€ (í˜¹ì‹œ ëª¨ë¥¼ ì¼€ì´ìŠ¤ ì»¤ë²„) */
.avatar, .avatar.lg{ aspect-ratio:1/1; border-radius:50%; overflow:hidden; }


</style>
</head>
<body>

<header class="topbar">
  <div class="container inner">
    <a class="brand" href="#/"><span class="badge">M</span><span>ë§ˆì¼“</span></a>
    <form class="search" onsubmit="event.preventDefault();doSearch()">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" aria-hidden="true"><path d="M11 4a7 7 0 105.292 12.292l3.707 3.707 1.414-1.414-3.707-3.707A7 7 0 0011 4z" fill="#64748b"/></svg>
      <input id="q" type="search" placeholder=" ex ìƒí’ˆëª…, ì§€ì—­"/>
      <button class="btn" type="submit">ê²€ìƒ‰</button>
    </form>
    <nav class="nav">
      <a class="btn" href="#/market">ë‘˜ëŸ¬ë³´ê¸°</a>
    </nav>
  </div>
</header>

<!-- Landing -->
<section id="landing" class="landing">
  <div class="container hero">
    <div>
      <h1 class="headline">ë™ë„¤ ì¤‘ê³ ê±°ë˜,<br/>ê°€ë³ê³  ì•ˆì „í•˜ê²Œ</h1>
      <p class="subtitle">ì§€ì—­ë³„ ì¤‘ê³ ê±°ë˜ Â· ì•ˆì „í•˜ê³  ì‹ ì†í•œ ê±°ë˜</p>
      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <a class="btn primary" href="#/market">ì§€ê¸ˆ ë‘˜ëŸ¬ë³´ê¸°</a>
        <span class="chip">ğŸ”’ ì•ˆì „ê²°ì œ</span>
        <span class="chip">âœ” ë™ë„¤ ì¸ì¦</span>
      </div>
    </div>
    <div class="phone">
      <div class="phone-in">
        <div class="phone-top"><span>ë§ˆì¼“</span><span style="font-size:12px;color:#334155">ë¶€ì‚°ì§„êµ¬</span></div>
        <div class="slot"><img src="landing.png" alt=""></div>
      </div>
    </div>
  </div>
</section>

<!-- LIST -->
<main id="page-home" class="container" aria-labelledby="home-title" style="display:none">
  <div class="shell">
    <aside class="panel shadow">
      <h3>ì¹´í…Œê³ ë¦¬</h3>
      <div class="facet" id="facet-cats"></div>

      <h3 style="margin-top:12px">ê°€ê²©(ì›)</h3>
      <div class="controls">
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
          <input id="minPrice" type="number" min="0" inputmode="numeric" placeholder="ìµœì†Œ"/>
          <input id="maxPrice" type="number" min="0" inputmode="numeric" placeholder="ìµœëŒ€"/>
        </div>
        <div class="row" style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
            <button class="btn" id="applyPrice">ì ìš©</button>
            <button class="btn" id="clearPrice">ì´ˆê¸°í™”</button>
          </div>

      <h3 style="margin-top:12px">ì •ë ¬</h3>
      <div class="facet" id="facet-sort">
        <label><input type="radio" name="sort" value="rel" checked>ì •í™•ë„<span class="count"></span></label>
        <label><input type="radio" name="sort" value="price_asc">ê°€ê²© â¬†ï¸<span class="count"></span></label>
        <label><input type="radio" name="sort" value="price_desc">ê°€ê²© â¬‡ï¸<span class="count"></span></label>
        <label><input type="radio" name="sort" value="new">ìµœì‹ ìˆœ<span class="count"></span></label>
      </div>
    </aside>

    <section>
      <header class="section-title">
        <h2 id="resultTitle">ì „ì²´ ë§¤ë¬¼</h2>
        <div style="display:flex;gap:8px;align-items:center">
          <span id="resultInfo" class="chip">0ê±´</span>
          <button id="resetAll" class="btn">ì „ì²´ ì´ˆê¸°í™”</button>
        </div>
      </header>
      <div id="grid" class="grid goods"></div>
      <div id="empty">ì¡°ê±´ì— ë§ëŠ” ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>
      <div id="moreWrap"><button id="moreBtn" class="btn">ë” ë³´ê¸°</button></div>
      <div id="sentinel" style="height:1px"></div>
    </section>
  </div>
</main>

<!-- DETAIL -->
<main id="page-detail" class="container" aria-labelledby="detail-title">
  <nav class="crumb">í™ˆ Â· <span id="crumb-cat">ì¹´í…Œê³ ë¦¬</span> Â· <span id="crumb-title">ìƒí’ˆ</span></nav>
  <div class="detail">
    <div>
      <section class="gallery panel">
        <div class="heroimg" id="heroBox"><img id="heroImg" alt="ëŒ€í‘œ ì´ë¯¸ì§€" loading="lazy"></div>
        <div class="thumbs" id="thumbs"></div>
      </section>

      <section class="tabs">
        <div class="tablist" role="tablist" aria-label="ìƒì„¸ íƒ­">
          <button class="tab" role="tab" aria-selected="true" aria-controls="tab-over" id="tabbtn-over">ê°œìš”</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-spec" id="tabbtn-spec">ìŠ¤í™</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-rev" id="tabbtn-rev">ë¦¬ë·°</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-qa" id="tabbtn-qa">Q&amp;A</button>
          <button class="tab" role="tab" aria-selected="false" aria-controls="tab-pol" id="tabbtn-pol">ì •ì±…</button>
        </div>
        <section id="tab-over" class="tabpanel panel active" role="tabpanel" aria-labelledby="tabbtn-over">
          <h3>ìƒí’ˆ ì„¤ëª…</h3>
          <p id="pdesc" style="color:#444;line-height:1.7"></p>
          <h3 style="margin-top:12px">íŠ¹ì§•</h3>
          <ul id="pfeatures" style="margin:6px 0 0 18px;color:#334155;line-height:1.7"></ul>
        </section>
        <section id="tab-spec" class="tabpanel panel" role="tabpanel" aria-labelledby="tabbtn-spec">
          <h3>ê¸°ë³¸ ì •ë³´</h3>
          <div class="kv" id="pspec" style="display:grid;grid-template-columns:130px 1fr;gap:8px"></div>
        </section>
        <section id="tab-rev" class="tabpanel panel reviews" role="tabpanel" aria-labelledby="tabbtn-rev">
          <div id="reviewsWrap"></div>
          <form id="reviewForm" style="margin-top:12px;display:grid;gap:8px">
            <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
              <label>ë³„ì 
                <select id="revStar">
                  <option>5</option><option>4</option><option>3</option><option>2</option><option>1</option>
                </select>
              </label>
              <input id="revName" placeholder="ë‹‰ë„¤ì„" style="flex:1;min-width:160px;border:1px solid var(--line);border-radius:8px;padding:8px"/>
              <button class="btn primary" type="submit">ë¦¬ë·° ë“±ë¡</button>
            </div>
            <textarea id="revText" placeholder="ì‚¬ìš© í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì„¸ìš”." style="border:1px solid var(--line);border-radius:8px;padding:10px;min-height:80px"></textarea>
          </form>
        </section>
        <section id="tab-qa" class="tabpanel panel qa" role="tabpanel" aria-labelledby="tabbtn-qa">
          <div id="qaWrap"></div>
          <form id="qaForm" style="margin-top:12px;display:grid;gap:8px">
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <input id="qaName" placeholder="ë‹‰ë„¤ì„" style="flex:1;min-width:160px;border:1px solid var(--line);border-radius:8px;padding:8px"/>
              <button class="btn primary" type="submit">ì§ˆë¬¸ ë“±ë¡</button>
            </div>
            <textarea id="qaText" placeholder="ìƒí’ˆì— ëŒ€í•´ ê¶ê¸ˆí•œ ì ì„ ì‘ì„±í•˜ì„¸ìš”." style="border:1px solid var(--line);border-radius:8px;padding:10px;min-height:80px"></textarea>
          </form>
        </section>
        <section id="tab-pol" class="tabpanel panel" role="tabpanel" aria-labelledby="tabbtn-pol">
          <h3>ê±°ë˜/ë°°ì†¡/í™˜ë¶ˆ ì •ì±…</h3>
          <ul id="ppolicy" style="margin:6px 0 0 18px;color:#334155;line-height:1.7"></ul>
        </section>
      </section>
    </div>

    <aside class="side">
    <section class="detail-card shadow tidy">
    <!-- ìƒë‹¨: ì œëª© / ì§€ì—­ / ì°œ -->
    <div class="detail-head">
      <div>
        <h1 id="ptitle" class="title big"></h1>
        <div class="meta location"><span id="parea"></span> Â· ë°©ê¸ˆ ì „</div>
      </div>
      <button class="btn like-top icon" id="likeBtn">â™¡ ì°œ</button>
    </div>
  
    <!-- ê°€ê²©/ìƒíƒœ -->
    <div class="price-box">
      <div id="pprice" class="price big"></div>
      <span class="chip tone" id="pcond">ìƒíƒœ</span>
    </div>
  
    <!-- í•µì‹¬ ë°°ì§€ -->
    <div class="pill-row" id="pbadges"></div>
  
    <hr class="sep"/>
  
    <!-- íŒë§¤ì ì¹´ë“œ -->
    <a id="sellerLink" class="seller-link seller-card" href="#">
      <div class="avatar lg" id="sellerAvatar"></div>
      <div class="seller-info">
        <strong id="sellerName">íŒë§¤ì</strong>
        <div class="meta" id="sellerMeta"></div>
      </div>
      <span class="forward" aria-hidden="true">â€º</span>
    </a>
  
    <!-- CTA -->
    <div class="cta-row">
      <button class="btn primary block" id="dealBtn">ğŸ’¬ ì±„íŒ…/ê±°ë˜í•˜ê¸°</button>
      <button class="btn block" id="copyLinkBtn">ë§í¬ ë³µì‚¬</button>
    </div>
  </section>
  

      <section class="detail-card">
        <h3 style="margin:0 0 8px">ë¹„ìŠ·í•œ ë§¤ë¬¼</h3>
        <div id="similar" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
      </section>

      <section class="detail-card">
        <h3 style="margin:0 0 8px">ìµœê·¼ ë³¸ ìƒí’ˆ</h3>
        <div id="recent" class="grid" style="grid-template-columns:repeat(2,1fr)"></div>
      </section>
    </aside>
  </div>

  <div class="bottombar">
    <div class="container">
      <button class="btn" id="likeBtnBottom">â™¡ ì°œ</button>
      <button class="btn primary" id="dealBtnBottom">ğŸ’¬ ì±„íŒ…/ê±°ë˜í•˜ê¸°</button>
    </div>
  </div>
</main>

<!-- SELLER PROFILE -->
<main id="page-seller" class="container" aria-labelledby="seller-title">
  <nav class="crumb">í™ˆ Â· íŒë§¤ì Â· <span id="sNameCrumb"></span></nav>
  <section class="detail-card">
    <div class="seller-head">
      <div class="avatar lg" id="sAvatar"></div>
      <div>
        <h1 id="sName" class="seller-title"></h1>
        <div class="seller-stats" id="sMeta"></div>
        <div class="seller-chips" id="sBadges"></div>
        <div class="seller-chips"><button class="btn" id="sellerChatBtn">ğŸ’¬ íŒë§¤ìì—ê²Œ ë¬¸ì˜</button></div>
      </div>
    </div>
  </section>

  <section style="margin-top:12px">
    <header class="section-title">
      <h2>íŒë§¤ ìƒí’ˆ</h2>
      <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <div id="sCatChips" class="seller-chips"></div>
        <span class="chip" id="sCount">0ê±´</span>
      </div>
    </header>
    <div id="sellerGrid" class="grid goods"></div>
  </section>
</main>

<!-- DEAL / CHAT -->
<main id="page-deal" class="container" aria-labelledby="deal-title">
  <nav class="crumb">í™ˆ Â· ê±°ë˜</nav>
  <section class="detail-card">
    <div class="deal-top">
      <div class="deal-thumb"><img id="dThumb" alt=""></div>
      <div>
        <h2 id="dTitle" style="margin:0 0 4px"></h2>
        <div class="deal-meta" id="dMeta"></div>
        <div class="deal-actions">
          <span class="chip" id="dStatus">ìš”ì²­ë¨</span>
          <button class="btn" id="dConfirm">êµ¬ë§¤ í™•ì •</button>
          <button class="btn ghost" id="dCancel">ê±°ë˜ ì·¨ì†Œ</button>
        </div>
      </div>
    </div>

    <div class="deal-form">
      <div class="deal-row">
        <strong>ë°©ì‹</strong>
        <button class="chip" data-mode="ì§ê±°ë˜">ì§ê±°ë˜</button>
        <button class="chip" data-mode="íƒë°°">íƒë°°</button>
        <button class="chip" data-mode="ì•ˆì „ê²°ì œ">ì•ˆì „ê²°ì œ(ë°ëª¨)</button>
      </div>
      <div class="deal-row">
        <strong>ì¥ì†Œ</strong>
        <input id="dPlace" placeholder="ì˜ˆ: ì—°ì‚°ì—­ 1ë²ˆ ì¶œêµ¬ ì• / ìš°ì²´êµ­ íƒë°°" />
      </div>
      <div class="deal-row">
        <strong>ì œì•ˆê°€</strong>
        <input id="dOffer" inputmode="numeric" placeholder="ì˜ˆ: 75,000" />
      </div>
    </div>

    <div class="chat" style="margin-top:12px">
      <div id="msgs" class="msgs"></div>
      <div class="composer">
        <input id="msgText" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”."/>
        <button class="btn primary" id="sendBtn">ì „ì†¡</button>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container foot">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
      <div style="display:flex;align-items:center;gap:8px"><span class="badge" style="width:28px;height:28px;border-radius:8px">M</span><strong>ë§ˆì¼“</strong></div>
      <div>â“’ 2025 ë§ˆì¼“ Â· All rights reserved.</div>
    </div>
  </div>
</footer>
<script>
/* ======================= ìƒìˆ˜/ì¹´í…Œê³ ë¦¬ ======================= */
const CATS=[{key:'digital',name:'ë””ì§€í„¸/ê°€ì „'},{key:'life',name:'ìƒí™œ/ê°€êµ¬'},{key:'hobby',name:'ì·¨ë¯¸/ê²Œì„'},{key:'child',name:'ìœ ì•„/ì˜ë¥˜'},{key:'sport',name:'ìŠ¤í¬ì¸ /ë ˆì €'},{key:'pet',name:'ë°˜ë ¤ë™ë¬¼'}];
const LABEL=Object.fromEntries(CATS.map(c=>[c.key,c.name]));

/* âœ… íŒë§¤ì í’€(ê³ ì •) */
const SELLERS=[
  {id:'s1',name:'ë§ˆì¼“ì…€ëŸ¬',since:'2021',trades:42,temp:36.5,resp:97,badges:['ì‹¤ëª…','ë™ë„¤ì¸ì¦'],avatar:'linear-gradient(135deg,#e2e8f0,#cbd5e1)',area:'ì—°ì œêµ¬ ì—°ì‚°ë™',bio:'ì—°ì‚°ë™ ì¤‘ì‹¬ìœ¼ë¡œ ë””ì§€í„¸/ê°€êµ¬ ìœ„ì£¼ íŒë§¤.'},
  {id:'s2',name:'êµ¿ë”œìƒì ',since:'2020',trades:128,temp:38.2,resp:99,badges:['í”„ë¦¬ë¯¸ì—„','ì•ˆì „ê²°ì œ'],avatar:'linear-gradient(135deg,#fde68a,#fca5a5)',area:'í•´ìš´ëŒ€êµ¬ ìš°ë™',bio:'ìš°ë™ ì§ê±°ë˜ ì„ í˜¸, ì•ˆì „ê²°ì œ í™˜ì˜.'},
  {id:'s3',name:'ë¶€ì‚°_íŒŒì›Œì…€ëŸ¬',since:'2019',trades:312,temp:39.1,resp:96,badges:['ìš°ìˆ˜íŒë§¤ì'],avatar:'linear-gradient(135deg,#93c5fd,#a7f3d0)',area:'ë¶€ì‚°ì§„êµ¬ ì „í¬ë™',bio:'ì½˜ì†”/ë³´ë“œê²Œì„ íŠ¹í™”. ë¹ ë¥¸ ì‘ë‹µ!'}
];

/* ìƒ˜í”Œ ë² ì´ìŠ¤ */
const BASE = [
  { id: 1, title: 'ì• í”Œ ë…¸íŠ¸ë¶ ë§¥ë¶ í”„ë¡œ 13', price: 650000, tag: 'digital', area: 'ë¶€ì‚°ì§„êµ¬ ì „í¬ë™', desc: 'M1/8GB/256GB, ìƒí™œê¸°ìŠ¤ ê±°ì˜ ì—†ìŒ', photos: ['https://images.unsplash.com/photo-1517336714731-489689fd1ca8?w=1200&auto=format&fit=crop&q=80'] },
  { id: 2, title: 'ì›ëª© 4ì¸ ì‹íƒ', price: 120000, tag: 'life', area: 'í•´ìš´ëŒ€êµ¬ ìš°ë™', desc: 'ì´ì‚¬ ì •ë¦¬, ì§ê±°ë˜ë§Œ', photos: ['https://images.unsplash.com/photo-1519710164239-da123dc03ef4?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1519710161600-19e1e4f0e7f8?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1519710164204-4f1a4a2c7f9c?w=1200&auto=format&fit=crop&q=80'] },
  { id: 3, title: 'ë‹Œí…ë„ ìŠ¤ìœ„ì¹˜ OLED', price: 300000, tag: 'hobby', area: 'ìˆ˜ì˜êµ¬ ê´‘ì•ˆë™', desc: 'íŒ¨ë“œ 2ê°œ + ì ¤ë‹¤ í¬í•¨', photos: ['https://images.unsplash.com/photo-1605901309584-818e25960a8b?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1606813907291-76a0d29f83ad?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1612036782180-6f0b2f0c6a4c?w=1200&auto=format&fit=crop&q=80'] },
  { id: 4, title: 'ìœ ì•„ í”¼ê·œì–´ ì„¸íŠ¸(10ì¢…)', price: 70000, tag: 'child', area: 'ì‚¬í•˜êµ¬ ì¥ë¦¼ë™', desc: 'ì•ˆì „ì„± í…ŒìŠ¤íŠ¸ ì™„ë£Œ, ëª¨ì„œë¦¬ ë¼ìš´ë”©', photos: ['https://images.unsplash.com/photo-1566576912321-d58ddd7a6088?w=900&auto=format&fit=crop&q=70','https://images.unsplash.com/photo-1601758124511-52d02a2b03c7?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1520975693412-35a1f8e9d7e8?w=1200&auto=format&fit=crop&q=80'] },
  { id: 5, title: 'LG 55ì¸ì¹˜ TV', price: 350000, tag: 'digital', area: 'ë™ë˜êµ¬ ëª…ë¥œë™', desc: 'ë²½ê±¸ì´ ë¸Œë¼ì¼“ í¬í•¨', photos: ['https://images.unsplash.com/photo-1583225173936-3a63d7f52c16?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1496181133206-80ce9b88a853?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1485846234645-a62644f84728?w=1200&auto=format&fit=crop&q=80'] },
  { id: 6, title: 'ê²Œì´ë° ì˜ì', price: 90000, tag: 'life', area: 'ë‚¨êµ¬ ëŒ€ì—°ë™', desc: 'ë¦¬í´ë¼ì´ë‹ ì–‘í˜¸', photos: ['https://images.unsplash.com/photo-1598300053650-5d0d1df3b9f5?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1616628188460-4f2e1f908db8?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1603481588273-0a3ee3c3d5fe?w=1200&auto=format&fit=crop&q=80'] },
  { id: 7, title: 'ë³´ë“œê²Œì„ ëª¨ìŒ', price: 60000, tag: 'hobby', area: 'ì—°ì œêµ¬ ì—°ì‚°ë™', desc: 'ìŠ¤í”Œë Œë”/ëŸ¬ë¸Œë ˆí„° ë“±', photos: ['https://images.unsplash.com/photo-1511512578047-dfb367046420?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1550179403-7215e4f3c2e9?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1518445181636-7a44a269a6b3?w=1200&auto=format&fit=crop&q=80'] },
  { id: 8, title: 'ë‚¨ì„± ì²­ë°”ì§€ 30~31', price: 30000, tag: 'child', area: 'ê¸ˆì •êµ¬ ì¥ì „ë™', desc: 'ìŠ¤íŠ¸ë ˆì´íŠ¸ í•, ì‚¬ìš©ê° ì ìŒ', photos: ['https://images.unsplash.com/photo-1516826957135-700dedea698c?w=1200&auto=format&fit=crop&q=80'] },
  { id: 9, title: '3ì¸ìš© íŒ¨ë¸Œë¦­ ì†ŒíŒŒ', price: 180000, tag: 'life', area: 'ì—°ì œêµ¬ ì—°ì‚°ë™', desc: 'ì¿ ì…˜ í¬í•¨, ìƒí™œì˜¤ì—¼ ì•½ê°„', photos: ['https://images.unsplash.com/photo-1549187774-b4e9b0445b06?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1554995207-c18c203602cb?w=1200&auto=format&fit=crop&q=80','https://images.unsplash.com/photo-1505691938895-1758d7feb511?w=1200&auto=format&fit=crop&q=80'] }
];

/* âœ… êµ¬-ë™ ë§¤í•‘ */
const AREA_MAP = {
  'ë¶€ì‚°ì§„êµ¬': ['ì „í¬ë™'],
  'ì‚¬í•˜êµ¬': ['ì¥ë¦¼ë™'],
  'ë™ë˜êµ¬': ['ëª…ë¥œë™'],
  'í•´ìš´ëŒ€êµ¬': ['ìš°ë™'],
  'ë‚¨êµ¬': ['ëŒ€ì—°ë™'],
  'ì—°ì œêµ¬': ['ì—°ì‚°ë™'],
  'ìˆ˜ì˜êµ¬': ['ê´‘ì•ˆë™'],
  'ê¸ˆì •êµ¬': ['ì¥ì „ë™']
};
const GUS = Object.keys(AREA_MAP);

const rnd=n=>Math.floor(Math.random()*n);
const pick=a=>a[rnd(a.length)];

/* ë©”íƒ€ ìƒì„± */
function buildMeta(row, seller){
  const policies=['íƒë°°ì‹œ ì„ ë¶ˆ/ì°©ë¶ˆ ì„ íƒ ê°€ëŠ¥(ë„ì„œì‚°ê°„ ì¶”ê°€)','ì—ìŠ¤í¬ë¡œ ê²°ì œ ì‚¬ìš© ì‹œ ì¸ìˆ˜í™•ì¸ í›„ ìë™ ì •ì‚°','ë‹¨ìˆœ ë³€ì‹¬ í™˜ë¶ˆì€ ì™•ë³µ ë°°ì†¡ë¹„ ë¶€ë‹´(ìˆ˜ë ¹ 7ì¼ ì´ë‚´)','ì œí’ˆ ìƒíƒœ ìƒì´/íŒŒì† ì‹œ íŒë§¤ì ê·€ì±… êµí™˜Â·í™˜ë¶ˆ'];
  let spec={},feats=[],cond=['A','A-','B+','B'][rnd(4)];
  if(row.tag==='digital'){spec={ë¸Œëœë“œ:pick(['Apple','Samsung','LG','Xiaomi']),ìš©ëŸ‰:pick(['64GB','128GB','256GB','512GB']),í™”ë©´:pick(['11"','12.9"','55"','65"']),ë°°í„°ë¦¬ê±´ê°•:(85+rnd(15))+'%',ëª¨ë¸ëª…:'Smart Tab'};feats=['ìƒí™œê¸°ìŠ¤ ë¯¸ì„¸','ì¼€ì´ìŠ¤/í•„ë¦„ í¬í•¨','ì¶©ì „ê¸° ë™ë´‰','ì´ˆê¸°í™” ì™„ë£Œ'];}
  else if(row.tag==='life'){spec={ì¬ì§ˆ:pick(['ì›ëª©','íŒ¨ë¸Œë¦­','ê°€ì£½','í•©íŒ']),ìƒ‰ìƒ:pick(['ë‚´ì¶”ëŸ´','ì›”ë„›','ê·¸ë ˆì´','ë² ì´ì§€']),í¬ê¸°:`${120+rnd(60)}Ã—${60+rnd(20)}Ã—${75+rnd(10)}cm`,êµ¬ì„±:'ë³¸í’ˆ/ì¿ ì…˜',ë¸Œëœë“œ:pick(['í•œìƒ˜','ì´ì¼€ì•„','ìì½”ëª¨','ë‹ˆí† ë¦¬'])};feats=['ìŠ¤í¬ë˜ì¹˜ ì•½ê°„','ê²¬ê³ í•œ í”„ë ˆì„','ê´€ë¦¬ ì‰¬ì›€'];}
  else if(row.tag==='hobby'){spec={ìœ í˜•:(row.title.includes('ìŠ¤ìœ„ì¹˜')?'ê²Œì„ì½˜ì†”':'ë³´ë“œê²Œì„'),êµ¬ì„±:(row.title.includes('ìŠ¤ìœ„ì¹˜')?'ë³¸ì²´/ì¡°ì´ì½˜Ã—2/ê²Œì„1':'ì¹´ë“œ/ë§/ì„¤ëª…ì„œ'),ì—°ë ¹:'ë§Œ 12ì„¸+',ë³´ì¦:'ë¯¸í¬í•¨'};feats=['ë¶€ì†í’ˆ ëˆ„ë½ ì—†ìŒ','ì—°íœ´ì— ë”±','ê°€ì¡±ëª¨ì„ ì¶”ì²œ'];}
  else if(row.tag==='child'){spec={ì‚¬ì´ì¦ˆ:pick(['100','110','120','130']),ê³„ì ˆ:pick(['ë´„/ê°€ì„','ê²¨ìš¸']),ì„¸íƒ:'ì™„ë£Œ',ë³´í’€:'ê±°ì˜ ì—†ìŒ'};feats=['ë‹´ìš”Â·ë§ˆìŠ¤í¬ ì¦ì •','ë¯¼ê°í”¼ë¶€ OK','í„¸ë¹ ì§ ì ìŒ'];}
  else if(row.tag==='sport'){spec={ë¸Œëœë“œ:pick(['Nike','Adidas','Mizuno']),ì‚¬ì´ì¦ˆ:pick(['260','265','270','275']),ìš©ë„:'ì”ë””/í’‹ì‚´',ë§ˆëª¨ë„:pick(['í•˜','ì¤‘','ìƒ'])};feats=['ë¯¸ë„ëŸ¼ ì ìŒ','ê°€ë²¼ìš´ ì°©í™”ê°','í’‹ì‚´ ì „ìš© ê¹”ì°½ í¬í•¨'];}
  else if(row.tag==='pet'){spec={ê¶Œì¥ì²´ì¤‘:'~7kg',ì¬ì§ˆ:'ë°©ìˆ˜ íŒ¨ë¸Œë¦­',í™˜ê¸°:'ë©”ì‰¬ 3ë©´',ì„¸íƒ:'ë¶€ë¶„ì„¸íƒ'};feats:['í™˜ê¸° ìš°ìˆ˜','ë°”ë‹¥ë¯¸ë„ëŸ¼ë°©ì§€','ì–´ê¹¨ëˆ íŒ¨ë“œ í¬í•¨'];}
  const sellerMeta={id:seller.id,name:seller.name,since:seller.since,trades:seller.trades,temp:seller.temp,resp:seller.resp,badges:[...seller.badges],avatar:seller.avatar,area:seller.area};
  return {cond,spec,feats,seller:sellerMeta,policies,photos:row.photos,featuresText:row.desc+' Â· ì‚¬ìš©ê° ì ê³  í…ŒìŠ¤íŠ¸ ì™„ë£Œ.'};
}

/* âœ… ë°ì´í„° ìƒì„± + íŒë§¤ì ë°°ì • */
const DATA=[]; let seq=1;
for(let i=0;i<9;i++){
  for(const b of BASE){
    const gu = pick(GUS);
    const dong = pick(AREA_MAP[gu]);
    const area = `${gu} ${dong}`;
    const price = Math.max(5000,Math.round(b.price*(0.6+0.8*Math.random())/1000)*1000);
    const seller=SELLERS[(seq)%SELLERS.length];
    const row={id:seq++,title:b.title,price,tag:b.tag,area,desc:b.desc,photos:b.photos,sellerId:seller.id};
    row.__meta=buildMeta(row,seller);
    DATA.push(row);
  }
}

/* ======================= ìƒíƒœ/ë¼ìš°í„° ======================= */
const state={q:'',cat:'all',min:null,max:null,sort:'rel',cursor:0,size:16,total:0,rows:[],likes:new Set(JSON.parse(localStorage.getItem('likes')||'[]')),recent:JSON.parse(localStorage.getItem('recent')||'[]')};

const router={
  parse(){
    const h=location.hash||'#/'; let m;
    if(m=h.match(/^#\/product\/(\d+)/)) return {page:'detail',id:+m[1]};
    if(m=h.match(/^#\/seller\/([\w-]+)/)) return {page:'seller',sid:m[1]};
    if(m=h.match(/^#\/deal\/(\d+)/)) return {page:'deal',pid:+m[1]};
    if(m=h.match(/^#\/market(?:\?(.*))?$/)){
      const sp=new URLSearchParams(m[1]||'');
      return {page:'home',params:{q:sp.get('q')||'',cat:sp.get('cat')||'all',min:sp.has('min')?+sp.get('min'):null,max:sp.has('max')?+sp.get('max'):null,sort:sp.get('sort')||'rel'}};
    }
    return {page:'landing'};
  },
  gotoHome(params={}){
    const p=new URLSearchParams();
    if(params.q)p.set('q',params.q);
    if(params.cat&&params.cat!=='all')p.set('cat',params.cat);
    if(params.min!=null)p.set('min',params.min);
    if(params.max!=null)p.set('max',params.max);
    if(params.sort&&params.sort!=='rel')p.set('sort',params.sort);
    location.hash='#/market'+(p.toString()?('?'+p.toString()):'');
  },
  apply(){
    const st=this.parse();
    document.getElementById('landing').style.display=(st.page==='landing')?'block':'none';
    document.getElementById('page-home').style.display=(st.page==='home')?'block':'none';
    document.getElementById('page-detail').classList.toggle('active',st.page==='detail');
    document.getElementById('page-seller').classList.toggle('active',st.page==='seller');
    document.getElementById('page-deal').classList.toggle('active',st.page==='deal');
    if(st.page==='home'){
      Object.assign(state,st.params,{cursor:0,rows:[]});
      syncFacet(); runSearch(true);
    } else if(st.page==='detail'){
      renderDetail(st.id); window.scrollTo({top:0,behavior:'instant'});
    } else if(st.page==='seller'){
      renderSeller(st.sid); window.scrollTo({top:0,behavior:'instant'});
    } else if(st.page==='deal'){
      renderDeal(st.pid); window.scrollTo({top:0,behavior:'instant'});
    }
  }
};
window.addEventListener('hashchange',()=>router.apply());

/* ======================= ê²€ìƒ‰/ì •ë ¬/í•„í„° ======================= */
function parseTokens(q){
  const toks=(q||'').trim().split(/\s+/).filter(Boolean);
  let f={words:[],tag:null,area:null,cmp:[]};
  for(const t of toks){
    let m;
    if(m=t.match(/^tag:(.+)$/i)){f.tag=m[1].toLowerCase();continue;}
    if(m=t.match(/^area:(.+)$/i)){f.area=m[1];continue;}
    if(m=t.match(/^price:(\d+)-(\d+)$/i)){f.cmp.push({op:'>=',v:+m[1]},{op:'<=',v:+m[2]});continue;}
    if(m=t.match(/^price([<>]=?)(\d+)$/i)){f.cmp.push({op:m[1],v:+m[2]});continue;}
    f.words.push(t.toLowerCase());
  }
  return f;
}
function matchRow(r,f){
  if(f.tag&&r.tag!==f.tag)return false;
  if(f.area&&!r.area.includes(f.area))return false;
  for(const w of f.words){
    const hay=(r.title+' '+r.desc+' '+r.area).toLowerCase();
    if(!hay.includes(w))return false;
  }
  for(const c of f.cmp){
    if(c.op==='<'&&!(r.price<c.v))return false;
    if(c.op==='>'&&!(r.price>c.v))return false;
    if(c.op==='<='){if(!(r.price<=c.v))return false;}
    if(c.op=== '>='){if(!(r.price>=c.v))return false;}
  }
  return true;
}
function score(r,f){
  let s=0;
  for(const w of f.words){
    if(r.title.toLowerCase().includes(w))s+=3;
    if(r.desc.toLowerCase().includes(w))s+=1;
    if(r.area.toLowerCase().includes(w))s+=1;
  }
  return s;
}
function runSearch(reset){
  if(reset){state.cursor=0;state.rows=[];}
  const f=parseTokens(state.q);
  let rows=DATA.filter(r=>matchRow(r,f));
  if(state.cat!=='all')rows=rows.filter(r=>r.tag===state.cat);
  if(state.min!=null)rows=rows.filter(r=>r.price>=state.min);
  if(state.max!=null)rows=rows.filter(r=>r.price<=state.max);
  if(state.sort==='price_asc')rows.sort((a,b)=>a.price-b.price);
  else if(state.sort==='price_desc')rows.sort((a,b)=>b.price-a.price);
  else if(state.sort==='new')rows.sort((a,b)=>b.id-a.id);
  else if(f.words.length){rows.sort((a,b)=>score(b,f)-score(a,f));}
  state.total=rows.length;
  const slice=rows.slice(state.cursor,state.cursor+state.size);
  state.rows=state.rows.concat(slice);
  state.cursor+=state.size;
  renderList(reset);
  handleSentinel(state.cursor<state.total);
}

/* ======================= ì¢Œì¸¡ íŒ¨ì‹¯ ======================= */
function renderFacet(){
  const counts=Object.fromEntries(CATS.map(c=>[c.key,0]));
  for(const r of DATA)counts[r.tag]++;
  const wrap=document.getElementById('facet-cats');
  wrap.innerHTML=
    `<label><input type="radio" name="cat" value="all"><span>ì „ì²´</span><span class="count">${DATA.length}</span></label>`+
    CATS.map(c=>`<label><input type="radio" name="cat" value="${c.key}"><span>${c.name}</span><span class="count">${counts[c.key]}</span></label>`).join('');
  document.querySelectorAll('#facet-cats input[name="cat"]').forEach(r=>r.addEventListener('change',()=>{state.cat=r.value;router.gotoHome(state);})); 
  document.querySelectorAll('#facet-sort input[name="sort"]').forEach(r=>r.addEventListener('change',()=>{state.sort=r.value;router.gotoHome(state);})); 
  document.getElementById('applyPrice').addEventListener('click',()=>{
    const mi=document.getElementById('minPrice').value?+document.getElementById('minPrice').value:null;
    const ma=document.getElementById('maxPrice').value?+document.getElementById('maxPrice').value:null;
    state.min=mi; state.max=ma; router.gotoHome(state);
  });
  document.getElementById('clearPrice').addEventListener('click',()=>{
    state.min=state.max=null; document.getElementById('minPrice').value=''; document.getElementById('maxPrice').value=''; router.gotoHome(state);
  });
}
function syncFacet(){
  document.getElementById('q').value=state.q;
  document.getElementById('minPrice').value=state.min??'';
  document.getElementById('maxPrice').value=state.max??'';
  document.querySelectorAll('#facet-cats input[name="cat"]').forEach(r=>r.checked=(r.value===state.cat));
  document.querySelectorAll('#facet-sort input[name="sort"]').forEach(r=>r.checked=(r.value===state.sort));
  document.getElementById('resultTitle').textContent=(state.cat==='all'?'ì „ì²´':LABEL[state.cat])+' ë§¤ë¬¼';
}

/* ======================= ì¹´ë“œ ë¦¬ìŠ¤íŠ¸ ======================= */
const fmt=n=>new Intl.NumberFormat('ko-KR').format(n)+'ì›';
function makeCardEl(m){
  const el=document.createElement('article');
  const badgeTxt=(m.__meta.cond||'A').startsWith('A')?'ìƒíƒœ Aê¸‰':'ìƒíƒœ ì–‘í˜¸';
  el.className='card';
  el.innerHTML=
    `<div class="thumb">
       <img loading="lazy" alt="${m.title}" src="${m.photos[0]||''}">
       <span class="badge-corner">${badgeTxt}</span>
       <button class="like">${state.likes.has(m.id)?'â¤ ì°œ':'â™¡ ì°œ'}</button>
     </div>
     <div class="meta">
       <div class="price">${fmt(m.price)}</div>
       <div class="title">${m.title}</div>
       <div class="desc">${m.area} Â· ${m.desc}</div>
     </div>`;
  const img=el.querySelector('img');
  img.onerror=()=>{const box=img.parentElement; box.classList.add('noimg'); img.remove();};
  el.querySelector('.like').addEventListener('click',(e)=>{e.stopPropagation();toggleLike(e.currentTarget,m.id);});
  el.addEventListener('click',()=>location.hash=`#/product/${m.id}`);
  return el;
}
function renderList(reset){
  const grid=document.getElementById('grid');
  const info=document.getElementById('resultInfo');
  const empty=document.getElementById('empty');
  const moreWrap=document.getElementById('moreWrap');
  if(reset)grid.innerHTML='';
  const start=state.rows.length-state.size<0?0:state.rows.length-state.size;
  const slice=state.rows.slice(start);
  const frag=document.createDocumentFragment();
  for(const m of slice){frag.appendChild(makeCardEl(m));}
  grid.appendChild(frag);
  info.textContent=`${state.total.toLocaleString()}ê±´`;
  empty.style.display=state.total?'none':'block';
  moreWrap.style.display=(state.cursor<state.total && !sentinelActive)?'flex':'none';
}
function toggleLike(btn,id){
  if(state.likes.has(id)){state.likes.delete(id);btn.textContent='â™¡ ì°œ';}
  else{state.likes.add(id);btn.textContent='â¤ ì°œ';}
  localStorage.setItem('likes',JSON.stringify([...state.likes]));
}
function toggleLikeDetail(btn,id){
  toggleLike(btn,id);
  document.getElementById('likeBtn').textContent=state.likes.has(id)?'â¤ ì°œ':'â™¡ ì°œ';
  const b=document.getElementById('likeBtnBottom'); if(b) b.textContent=state.likes.has(id)?'â¤ ì°œ':'â™¡ ì°œ';
}

/* ======================= ìƒì„¸ ======================= */
function getSimilarItems(item){
  let list=DATA.filter(r=>r.tag===item.tag && r.id!==item.id);
  if(list.length<4){
    const extra=DATA.filter(r=>r.id!==item.id)
      .sort((a,b)=>Math.abs(a.price-item.price)-Math.abs(b.price-item.price));
    for(const x of extra){ if(!list.includes(x)) list.push(x); if(list.length>=4) break; }
  }
  return list.slice(0,4);
}
function renderDetail(id){
  const item=DATA.find(r=>r.id===id);
  if(!item){alert('ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); router.gotoHome({}); return;}
  state.recent=[id,...state.recent.filter(x=>x!==id)].slice(0,8);
  localStorage.setItem('recent',JSON.stringify(state.recent));

  const meta=item.__meta;
  document.getElementById('ptitle').textContent=item.title;
  document.getElementById('pprice').textContent=fmt(item.price);
  document.getElementById('parea').textContent=item.area;
  document.getElementById('pcond').textContent='ìƒíƒœ '+meta.cond;
  document.getElementById('pbadges').innerHTML=['ğŸ”’ ì•ˆì „ê²°ì œ','ğŸšš íƒë°°/ì§ê±°ë˜','âœ” ì‹¤ëª… ì¸ì¦'].map(t=>`<span class="chip">${t}</span>`).join('');

  const likeBtn=document.getElementById('likeBtn');
  likeBtn.textContent=state.likes.has(item.id)?'â¤ ì°œ':'â™¡ ì°œ';
  likeBtn.onclick=()=>toggleLikeDetail(likeBtn,item.id);

  const bottomBtn=document.getElementById('likeBtnBottom');
  if(bottomBtn){
    bottomBtn.textContent=state.likes.has(item.id)?'â¤ ì°œ':'â™¡ ì°œ';
    bottomBtn.onclick=()=>toggleLikeDetail(likeBtn,item.id);
  }

  // íŒë§¤ì ë§í¬/ì •ë³´
  const s=meta.seller;
  const sLink=document.getElementById('sellerLink');
  sLink.href=`#/seller/${item.sellerId}`;
  document.getElementById('sellerName').textContent=s.name;
  document.getElementById('sellerMeta').textContent=`${s.area} Â· ê±°ë˜ ${s.trades} Â· ì‘ë‹µë¥  ${s.resp}% Â· ë§¤ë„ˆì˜¨ë„ ${s.temp}Â° Â· since ${s.since}`;
  document.getElementById('sellerAvatar').style.background=s.avatar;

  document.getElementById('crumb-cat').textContent=LABEL[item.tag]||item.tag;
  document.getElementById('crumb-title').textContent=item.title;

  // ê°¤ëŸ¬ë¦¬
  const heroBox=document.getElementById('heroBox'); const hero=document.getElementById('heroImg');
  heroBox.classList.remove('noimg'); hero.src='';
  if(item.photos && item.photos.length){
    hero.src=item.photos[0];
    hero.onerror=()=>{heroBox.classList.add('noimg'); hero.removeAttribute('src');};
  } else { heroBox.classList.add('noimg'); }
  const tWrap=document.getElementById('thumbs'); const thumbs=item.photos||[];
  tWrap.innerHTML=thumbs.map((u,i)=>`<button aria-label="thumb ${i+1}"><img loading="lazy" src="${u}" alt=""></button>`).join('');
  document.querySelectorAll('#thumbs button').forEach(b=>b.addEventListener('click',()=>{heroBox.classList.remove('noimg'); hero.src=b.querySelector('img').src;}));

  // íƒ­ + ì½˜í…ì¸ 
  document.getElementById('pdesc').textContent=meta.featuresText;
  document.getElementById('pfeatures').innerHTML=meta.feats.map(x=>`<li>${x}</li>`).join('');
  document.getElementById('ppolicy').innerHTML=meta.policies.map(x=>`<li>${x}</li>`).join('');
  const specKV=document.getElementById('pspec');
  specKV.innerHTML=Object.entries(meta.spec).map(([k,v])=>`<div>${k}</div><div>${v}</div>`).join('');
  const rKey=`rev_${id}`;
  if(!localStorage.getItem(rKey)){
    localStorage.setItem(rKey,JSON.stringify([{n:'ë¶€ì‚°*ë•',s:5,t:'ê±°ì˜ ìƒˆê²ƒì´ì—ìš”. í¬ì¥ë„ ê¹”ë”!'}, {n:'ì—°ì œ*ë§˜',s:4,t:'ì‚¬ì§„ë³´ë‹¤ ì‹¤ë¬¼ì´ ë” ì˜ˆì¨. ì¶”ì²œí•©ë‹ˆë‹¤.'}]));
  }
  drawReviews(id);
  const qKey=`qa_${id}`;
  if(!localStorage.getItem(qKey)){
    localStorage.setItem(qKey,JSON.stringify([{n:'ìµëª…',q:'ì§ê±°ë˜ ê°€ëŠ¥í• ê¹Œìš”?',a:'ë„¤, ì—°ì‚°ë™ ì£¼ë§ ê°€ëŠ¥í•´ìš”.'},{n:'ì‚¬ìš©ì',q:'íƒë°° ì‹œ ë°•ìŠ¤í¬ì¥ ë˜ë‚˜ìš”?',a:'ì™„ì¶©ì¬+ì´ì¤‘í¬ì¥ìœ¼ë¡œ ë°œì†¡í•©ë‹ˆë‹¤.'}]));
  }
  drawQA(id);
  bindTabs();

  // ìœ ì‚¬/ìµœê·¼
  const similar=getSimilarItems(item);
  document.getElementById('similar').innerHTML=similar.map(s=>`<a class="card" href="#/product/${s.id}">
    <div class="thumb"><img loading="lazy" src="${s.photos[0]||''}" alt="${s.title}"></div>
    <div class="meta"><div class="title" style="font-weight:800">${s.title}</div><div>${fmt(s.price)}</div></div>
  </a>`).join('');
  document.querySelectorAll('#similar img').forEach(img=>img.onerror=()=>{img.parentElement.classList.add('noimg'); img.remove();});

  const recItems=state.recent.filter(x=>x!==id).map(i=>DATA.find(r=>r.id===i)).filter(Boolean).slice(0,4);
  const recentBox=document.getElementById('recent');
  recentBox.innerHTML=recItems.length?recItems.map(s=>`<a class="card" href="#/product/${s.id}">
    <div class="thumb"><img loading="lazy" src="${s.photos[0]||''}" alt="${s.title}"></div>
    <div class="meta"><div class="title" style="font-weight:800">${s.title}</div><div>${fmt(s.price)}</div></div>
  </a>`).join(''):'<div class="meta" style="color:#64748b">ìµœê·¼ ë³¸ ìƒí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</div>';

  document.querySelectorAll('#recent img').forEach(img => {
  img.onerror = () => {
    const box = img.parentElement;
    box.classList.add('noimg'); // .thumb.noimg::after ê°€ "ì „ì‹œ ì¤€ë¹„ì¤‘"ì„ í‘œì‹œí•¨
    img.remove();
  };
});

  // ê±°ë˜ ë²„íŠ¼
  document.getElementById('dealBtn').onclick=()=>startDeal(id);
  const db=document.getElementById('dealBtnBottom'); if(db) db.onclick=()=>startDeal(id);

  // ë§í¬ ë³µì‚¬
  document.getElementById('copyLinkBtn').onclick=()=>{
    navigator.clipboard?.writeText(location.href).then(()=>alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.'));
  };
}

/* ======================= íŒë§¤ì í”„ë¡œí•„ ======================= */
function renderSeller(sid, cat='all'){
  const s=SELLERS.find(x=>x.id===sid);
  if(!s){alert('íŒë§¤ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); router.gotoHome({}); return;}
  document.getElementById('sNameCrumb').textContent=s.name;
  document.getElementById('sName').textContent=s.name;
  document.getElementById('sAvatar').style.background=s.avatar;
  document.getElementById('sMeta').textContent=`${s.area} Â· ê±°ë˜ ${s.trades} Â· ì‘ë‹µë¥  ${s.resp}% Â· ë§¤ë„ˆì˜¨ë„ ${s.temp}Â° Â· since ${s.since}`;
  document.getElementById('sBadges').innerHTML=s.badges.map(b=>`<span class="chip">âœ” ${b}</span>`).join('');
  document.getElementById('sellerChatBtn').onclick=()=>{
    const any=DATA.find(r=>r.sellerId===sid) || DATA[0];
    startDeal(any.id);
  };

  const all=DATA.filter(r=>r.sellerId===sid);
  const byCat=Object.fromEntries(CATS.map(c=>[c.key,0]));
  all.forEach(r=>byCat[r.tag]++);
  const chips=document.getElementById('sCatChips');
  const totalLabel=`ì „ì²´ ${all.length}ê±´`;
  chips.innerHTML=
    `<button class="chip ${cat==='all'?'active':''}" data-cat="all">${totalLabel}</button>`+
    CATS.filter(c=>byCat[c.key]>0).map(c=>`<button class="chip ${cat===c.key?'active':''}" data-cat="${c.key}">${LABEL[c.key]} ${byCat[c.key]}ê±´</button>`).join('');
  chips.querySelectorAll('.chip').forEach(btn=>{ btn.onclick=()=>{renderSeller(sid, btn.dataset.cat);} });

  const list=(cat==='all')?all:all.filter(r=>r.tag===cat);
  document.getElementById('sCount').textContent=`${list.length}ê±´`;
  const grid=document.getElementById('sellerGrid'); grid.innerHTML='';
  const frag=document.createDocumentFragment();
  list.forEach(m=>frag.appendChild(makeCardEl(m)));
  grid.appendChild(frag);
}

/* ======================= ê±°ë˜/ì±„íŒ… ======================= */
function startDeal(pid){ location.hash=`#/deal/${pid}`; }

function ensureDeal(pid){
  const item=DATA.find(r=>r.id===pid);
  const key=`deal_${pid}`;
  if(!localStorage.getItem(key)){
    const init={
      pid,
      status:'ìš”ì²­ë¨',
      mode:'ì§ê±°ë˜',
      place:item.area,
      offer:item.price,
      msgs:[
        {who:'other',text:`ì•ˆë…•í•˜ì„¸ìš”, ${item.__meta.seller.name}ì…ë‹ˆë‹¤. ë¬¸ì˜ ì£¼ì‹œë©´ ë¹ ë¥´ê²Œ ë‹µì¥ë“œë¦´ê²Œìš”.`,ts:Date.now()}
      ]
    };
    localStorage.setItem(key,JSON.stringify(init));
  }
  return key;
}

/* === ê°„ë‹¨í•œ ëŒ€í™” ì´í•´ ë¡œì§ === */
function parsePriceKR(text){
  // 7ë§Œ / 7.5ë§Œ / 75,000 / 75000 / 7ë§Œ5ì²œ
  let t=text.replace(/\s+/g,'').toLowerCase();
  const numComma=t.match(/(\d{1,3}(?:,\d{3})+|\d+)\s*ì›?/);
  if(numComma){ return Math.max(0, parseInt(numComma[1].replace(/,/g,''),10)); }
  const man=t.match(/(\d+(?:\.\d+)?)\s*ë§Œ/);
  if(man){ return Math.round(parseFloat(man[1])*10000); }
  const manCheon=t.match(/(\d+)\s*ë§Œ\s*(\d+)\s*ì²œ?/);
  if(manCheon){ return parseInt(manCheon[1],10)*10000 + parseInt(manCheon[2],10)*1000; }
  return null;
}
function containsAny(t, arr){ t=t.toLowerCase(); return arr.some(k=>t.includes(k)); }
function roundK(n){ return Math.max(1000, Math.round(n/1000)*1000); }

function autoReplyFor(text, item, deal){
  const low=text.toLowerCase();
  const price=item.price;
  const offer=parsePriceKR(text);
  const wantsDiscount = containsAny(low,['í• ì¸','ë„¤ê³ ','ì—ëˆŒ','ê°€ê²©','dc','ì¢€ë¹¼','ê¹']);
  const wantsMode = containsAny(low,['ì§ê±°ë˜','íƒë°°','ì•ˆì „ê²°ì œ']);
  const timeHint = /(\d{1,2})\s*ì‹œ(\s*\d{1,2}\s*ë¶„)?|ëª‡\s*ì‹œ|ì˜¤í›„|ì €ë…|ì•„ì¹¨/.test(low);
  const placeHint = containsAny(low,['ì–´ë””','ì¥ì†Œ','ì—­','ë§Œë‚˜ìš”','ë§Œë‚˜','ìœ„ì¹˜']);

  // 1) ê°€ê²© ì œì•ˆ/í• ì¸
  if(offer!=null || wantsDiscount){
    if(offer==null){
      return `í• ì¸ ê°€ëŠ¥ ë²”ìœ„ë¥¼ ì•Œë ¤ì£¼ì‹œë©´ ê²€í† í•´ë³¼ê²Œìš”. ë³´í†µ ${fmt(roundK(price*0.95))} ê·¼ì²˜ì—ì„œ ë§ì´ ê±°ë˜ë¼ìš”.`;
    }
    deal.offer=offer;
    if(offer >= price*0.95){
      deal.status='ê°€ê²© í•©ì˜';
      return `ë„¤, ${fmt(offer)}ì— ë“œë¦´ê²Œìš”. ${deal.mode}ë¡œ ì§„í–‰í• ê¹Œìš”? ê°€ëŠ¥í•œ ì‹œê°„ë„ ì•Œë ¤ì£¼ì„¸ìš”.`;
    }
    if(offer >= price*0.85){
      const counter=roundK((offer + price*0.95)/2);
      deal.offer=counter;
      return `ê·¸ ê°€ê²©ì€ ì¡°ê¸ˆ ì–´ë ¤ì›Œì„œ ${fmt(counter)}ì´ë©´ ë°”ë¡œ ê±°ë˜ ê°€ëŠ¥í•´ìš”. ê´œì°®ìœ¼ì„¸ìš”?`;
    }
    const min=roundK(price*0.9);
    deal.offer=min;
    return `ê·¸ ì •ë„ë¡œëŠ” ì–´ë µê³ , ìµœì €ê°€ê°€ ${fmt(min)}ì…ë‹ˆë‹¤. ê°€ëŠ¥í•˜ì‹œë©´ ì§„í–‰í• ê²Œìš”.`;
  }

  // 2) ê±°ë˜ ë°©ì‹
  if(wantsMode){
    if(low.includes('ì§ê±°ë˜')) deal.mode='ì§ê±°ë˜';
    if(low.includes('íƒë°°')) deal.mode='íƒë°°';
    if(low.includes('ì•ˆì „ê²°ì œ')) deal.mode='ì•ˆì „ê²°ì œ';
    return `${deal.mode} í™•ì¸í–ˆìŠµë‹ˆë‹¤. ${deal.mode==='ì§ê±°ë˜'?'ê°€ëŠ¥í•œ ì¥ì†Œì™€ ì‹œê°„':'ë°›ìœ¼ì‹¤ ì£¼ì†Œì™€ ì„±í•¨/ì—°ë½ì²˜'} ì•Œë ¤ì£¼ì„¸ìš”.`;
  }

  // 3) ì‹œê°„/ì¥ì†Œ
  const defaultPlace = item.area.replace(/ .*/,'')+'ì—­ 1ë²ˆ ì¶œêµ¬';
  if(timeHint && !placeHint){
    return `ì‹œê°„ ì¢‹ìŠµë‹ˆë‹¤. ì¥ì†ŒëŠ” ${defaultPlace} ì–´ë– ì„¸ìš”?`;
  }
  if(placeHint && !timeHint){
    return `ì¥ì†ŒëŠ” ${defaultPlace} ì œì•ˆë“œë ¤ìš”. ê°€ëŠ¥í•˜ì‹  ì‹œê°„ëŒ€ë¥¼ ì•Œë ¤ì£¼ì„¸ìš”.`;
  }

  // 4) ê¸°íƒ€
  return `ë„¤, í™•ì¸í–ˆìŠµë‹ˆë‹¤. ${deal.mode==='ì§ê±°ë˜'?'ê°€ëŠ¥í•œ ì‹œê°„ê³¼ ì¥ì†Œ':'ë°›ìœ¼ì‹¤ ì£¼ì†Œ'} ì•Œë ¤ì£¼ì‹œë©´ ì§„í–‰í•˜ê² ìŠµë‹ˆë‹¤.`;
}

function renderDeal(pid){
  const item=DATA.find(r=>r.id===pid);
  if(!item){alert('ê±°ë˜ ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'); router.gotoHome({}); return;}
  const key=ensureDeal(pid);
  const deal=JSON.parse(localStorage.getItem(key));

  // ìƒë‹¨ ì •ë³´
  document.getElementById('dThumb').src=item.photos[0]||'';
  document.getElementById('dTitle').textContent=item.title;
  document.getElementById('dMeta').textContent=`${item.__meta.seller.name} Â· ${fmt(item.price)} Â· ${item.area}`;
  document.getElementById('dStatus').textContent=deal.status;
  document.getElementById('dPlace').value=deal.place||'';
  document.getElementById('dOffer').value=deal.offer||'';

  // ë°©ì‹ ì„ íƒ
  document.querySelectorAll('.deal-row [data-mode]').forEach(b=>{
    b.classList.toggle('active', b.dataset.mode===deal.mode);
    b.onclick=()=>{deal.mode=b.dataset.mode; saveDeal(); renderDeal(pid);};
  });

  // ì…ë ¥ í•¸ë“¤ëŸ¬
  document.getElementById('dPlace').onchange=(e)=>{deal.place=e.target.value; saveDeal();};
  document.getElementById('dOffer').onchange=(e)=>{deal.offer=e.target.value; saveDeal();};

  // ìƒíƒœ ë²„íŠ¼
  document.getElementById('dConfirm').onclick=()=>{deal.status='êµ¬ë§¤ í™•ì •'; addMsg('me','êµ¬ë§¤ í™•ì •í•©ë‹ˆë‹¤.'); saveDeal(); renderDeal(pid);};
  document.getElementById('dCancel').onclick=()=>{deal.status='ê±°ë˜ ì·¨ì†Œ'; addMsg('me','ì£„ì†¡í•©ë‹ˆë‹¤. ê±°ë˜ ì·¨ì†Œí• ê²Œìš”.'); saveDeal(); renderDeal(pid);};

  // ë©”ì‹œì§€ ë Œë”
  const box=document.getElementById('msgs');
  box.innerHTML=deal.msgs.map(m=>`<div class="msg ${m.who}">${m.text}</div>`).join('');
  box.scrollTop=box.scrollHeight;

  // ì „ì†¡
  document.getElementById('sendBtn').onclick=send;
  document.getElementById('msgText').onkeydown=(e)=>{if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();send();}};
  function send(){
    const v=document.getElementById('msgText').value.trim();
    if(!v) return;
    addMsg('me',v); document.getElementById('msgText').value='';
    // ë˜‘ë˜‘í•œ ìë™ì‘ë‹µ
    const reply=autoReplyFor(v,item,deal);
    setTimeout(()=>{ addMsg('other',reply); saveDeal(); renderDeal(pid); },500);
    saveDeal(); renderDeal(pid);
  }

  function addMsg(who,text){ deal.msgs.push({who,text,ts:Date.now()}); }
  function saveDeal(){ localStorage.setItem(key,JSON.stringify(deal)); }
}

/* ë¦¬ë·° / QA */
function drawReviews(id){
  const rKey=`rev_${id}`;
  const list=JSON.parse(localStorage.getItem(rKey)||'[]');
  const w=document.getElementById('reviewsWrap');
  w.innerHTML=list.map(r=>`<div class="item"><div class="stars">${'â˜…'.repeat(r.s)}${'â˜†'.repeat(5-r.s)}</div><div><strong>${r.n}</strong></div><div>${r.t}</div></div>`).join('')||'<div class="item">ì•„ì§ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
  document.getElementById('reviewForm').onsubmit=(e)=>{
    e.preventDefault();
    const s=+document.getElementById('revStar').value||5;
    const n=(document.getElementById('revName').value||'ìµëª…').slice(0,12);
    const t=(document.getElementById('revText').value||'').trim();
    if(!t){alert('í›„ê¸°ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
    const arr=JSON.parse(localStorage.getItem(rKey)||'[]');
    arr.unshift({n:n,s:s,t:t});
    localStorage.setItem(rKey,JSON.stringify(arr));
    document.getElementById('revText').value='';
    drawReviews(id);
  };
}
function drawQA(id){
  const qKey=`qa_${id}`;
  const list=JSON.parse(localStorage.getItem(qKey)||'[]');
  const w=document.getElementById('qaWrap');
  w.innerHTML=list.map(q=>`<div class="item" style="padding:10px 0;border-bottom:1px dashed #eaecef"><div class="q">Q. ${q.q} â€” <small>${q.n}</small></div><div class="a">A. ${q.a||'íŒë§¤ìê°€ í™•ì¸ ì¤‘ì…ë‹ˆë‹¤.'}</div></div>`).join('');
  document.getElementById('qaForm').onsubmit=(e)=>{
    e.preventDefault();
    const n=(document.getElementById('qaName').value||'ìµëª…').slice(0,12);
    const t=(document.getElementById('qaText').value||'').trim();
    if(!t){alert('ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}
    const arr=JSON.parse(localStorage.getItem(qKey)||'[]');
    arr.unshift({n:n,q:t,a:''});
    localStorage.setItem(qKey,JSON.stringify(arr));
    document.getElementById('qaText').value='';
    drawQA(id);
  };
}

/* íƒ­ */
function bindTabs(){
  ['over','spec','rev','qa','pol'].forEach(k=>{
    const btn=document.getElementById('tabbtn-'+k);
    btn.onclick=()=>{
      document.querySelectorAll('.tab').forEach(b=>b.setAttribute('aria-selected','false'));
      btn.setAttribute('aria-selected','true');
      document.querySelectorAll('.tabpanel').forEach(p=>p.classList.remove('active'));
      document.getElementById('tab-'+k).classList.add('active');
    };
  });
}

/* ë¬´í•œìŠ¤í¬ë¡¤ */
let sentinelActive=false, io=null;
function handleSentinel(on){
  const s=document.getElementById('sentinel');
  const moreWrap=document.getElementById('moreWrap');
  if(on && !sentinelActive){
    try{
      io=new IntersectionObserver(es=>{if(es.some(e=>e.isIntersecting))runSearch(false);},{rootMargin:'280px'});
      io.observe(s); sentinelActive=true; moreWrap.style.display='none';
    }catch{ sentinelActive=false; moreWrap.style.display='flex';}
  } else if(!on && sentinelActive){
    io.disconnect(); io=null; sentinelActive=false; moreWrap.style.display='none';
  }
  document.getElementById('moreBtn').onclick=()=>runSearch(false);
}

/* ì „ì—­ ê²€ìƒ‰ + ì´ˆê¸°í™” ë²„íŠ¼ */
function doSearch(){state.q=(document.getElementById('q').value||'').trim(); router.gotoHome(state);}
window.doSearch=doSearch;

document.getElementById('resetAll').addEventListener('click',()=>{
  state.q=''; state.cat='all'; state.min=null; state.max=null; state.sort='rel';
  document.getElementById('q').value='';
  router.gotoHome(state);
});

/* ì´ˆê¸° ì„¤ì • */
(function init(){
  if(!location.hash) location.hash='#/';
  renderFacet();
  router.apply();
})();
</script>
</body>
</html>
